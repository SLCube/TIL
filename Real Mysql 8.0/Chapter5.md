# chapter 5 트랜잭션과 잠금

트랜잭션과 잠금은 서로 비슷한 개념 같지만 명확한 차이가 있다.

- 잠금 : 동시성을 제어하기위한 기능
- 트랜잭션 : 데이터의 정합성을 보장하는 기능

회원 정보 레코드를 여러 커넥션에서 동시에 변경하려 하는데 잠금이 없다면 하나의 데이터를 여러 커넥션에서 동시에 변경할 수 있게된다.

## 5.1 트랜잭션
MyISAM이나 MEMORY 스토리지 엔진은 트랜잭션을 지원하지 않지만 InnoDB는 트랜잭션을 지원한다.

### 5.1.1 MySQL에서의 트랜잭션 
트랜잭션은 하나의 논리적인 작업 셋(set)이 100% 적용되거나(commit) 아무것도 적용되지 않아야 한다(rollback). 그 작업 셋에 쿼리가 몇개가 있던 상관없다.

다음은 InnoDB와 MyISAM 테이블에서의 차이이다.

```sql 
create table tab_myisam(fdpk int not null, primary key(fdpk)) engine=MyISAM;

insert into tab_myisam (fdpk) values(3);

create table tab_innodb (fdpk int not null, primary key(fdpk)) engine=INNODB;
insert into tab_innodb(fdpk) values(3);
```

```sql
set autocommit = on;

insert into tab_myisam (fdpk) values (1), (2), (3);

insert into tab_innodb (fdpk) values (1), (2), (3);
```

결과는 myisam쪽은 1, 2, 3이 모두 들어가지만 innodb는 3만 들어가있는 상태가 된다.(innodb는 트랜잭션을 지원해 작업 전체가 롤백되기 때문이다.)

### 5.1.2 주의사항
트랜잭션은 DBMS 커넥션과 마찬가지로 꼭 필요한 코드에만 적용하는것이 좋다. 즉 프로그램에서 트랜잭션의 범위를 최소한으로 하라는 말이다. 

책에서 소개하는 예시이다.(사용자가 게시판에 게시물을 작성한 후 서버에서 처리하는 내용이다.)

1. 처리 시작
    - -> DB 커넥션 생성
    - -> 트랜잭션 시작
2. 사용자의 로그인 여부 확인
3. 사용자의 글쓰기 내용의 오류 여부 확인
4. 첨부로 업로드된 파일 확인 및 저장
5. 사용자의 입력 내용을 DBMS에 저장
6. 첨부 파일 정보를 DBMS에 저장
7. 저장된 내용 또는 기타 정보를 DBMS에서 조회
8. 게시물 등록에 대한 알림 메일 발송
9. 알림 메일 발송 이력을 DBMS에 저장
    - <- 트랜잭션 종료(commit)
    - <- DB 커넥션 반납
10. 처리완료

커넥션과 트랜잭션의 범위는 최대한 작게 갖고가는것이 좋다. 


- 커넥션 : db커넥션은 갯수가 제한적이라 커넥션을 소유하고 있는 시간이 길어지면 길어질수록 여유 커넥션 갯수가 줄어들 것이다. 위 예시로 봤을때 2, 3, 4번 과정이 아무리 빨라도 불필요한 시간이기 때문에 최악의 경우엔 커넥션이 부족할 수 있다.
- 트랜잭션 : 이 처리절차에는 DBMS작업이 총 4가지가 있는데 사용자가 입력한 정보를 저장하는 5, 6번은 하나의 트랜잭션으로 묶어야하며, 7번의경우 단순조회이기 때문에 트랜잭션에 포함시키지 않아도 되고 9번의 경우 5, 6번과의 성격이 조금 다르기 때문에 별도의 트랜잭션에 포함시켜야한다.

개선하면 다음과 같다.
1. 처리시작
2. 로그인 여부 확인
3. 글쓰기 내용의 오류 발생 여부 확인
4. 업로드된 파일 확인 및 저장
    - -> 커넥션 생성
    - -> 트랜잭션 시작
5. 입력내용 dbms저장
6. 첨부파일 정보 dbms저장
    - <- commit
7. 저장된 내용 또는 기타 정보를 dbms에서 조회
8. 